/**
 * Add Size Variants to Existing Ring Products
 * 
 * This script updates existing ring products with size variant data
 * including pricing, availability, and delivery information.
 * 
 * Usage: node scripts/add-size-variants.js
 */

const fs = require('fs');
const path = require('path');

// Standard US ring sizes
const RING_SIZES = ['5', '5.5', '6', '6.5', '7', '7.5', '8', '8.5', '9', '9.5'];

/**
 * Generate size variants for a product
 * @param {Object} product - Product object
 * @returns {Array} Array of size variant objects
 */
function generateSizeVariants(basePrice) {
  const variants = [];
  
  RING_SIZES.forEach((size, index) => {
    // Price variation: smaller and larger sizes often cost more
    let priceAdjustment = 0;
    const sizeNum = parseFloat(size);
    
    if (sizeNum < 6) {
      priceAdjustment = -50; // Smaller sizes slightly cheaper
    } else if (sizeNum >= 8.5) {
      priceAdjustment = 100; // Larger sizes more expensive (more metal)
    } else if (sizeNum >= 7.5) {
      priceAdjustment = 50;
    }
    
    // Vary availability - most in stock, some made to order
    const isAvailable = Math.random() > 0.2; // 80% available
    const stockQuantity = isAvailable ? Math.floor(Math.random() * 10) + 1 : 0;
    
    // Delivery varies by availability
    let deliveryDays;
    let availabilityMessage;
    
    if (stockQuantity > 5) {
      deliveryDays = 2;
      availabilityMessage = 'In Stock - Ready to Ship';
    } else if (stockQuantity > 0) {
      deliveryDays = 3;
      availabilityMessage = 'In Stock';
    } else {
      deliveryDays = 14;
      availabilityMessage = 'Made to Order';
    }
    
    variants.push({
      size: size,
      price: basePrice + priceAdjustment,
      available: isAvailable,
      stockQuantity: stockQuantity,
      availabilityMessage: availabilityMessage,
      deliveryDays: deliveryDays,
      sku: null // Will be generated by product SKU + size
    });
  });
  
  return variants;
}

/**
 * Main execution
 */
async function main() {
  console.log('üöÄ Starting to add size variants to ring products...\n');
  
  try {
    // Load Strapi instance for v5
    const Strapi = require('@strapi/strapi');
    const app = await Strapi().load();
    
    console.log('‚úÖ Strapi loaded successfully\n');
    
    // Fetch all products with their category relation
    const products = await strapi.entityService.findMany('api::product.product', {
      populate: {
        category: true,
        metal: true,
        style: true,
      },
    });
    
    console.log(`üì¶ Found ${products.length} total products\n`);
    
    let updatedCount = 0;
    let skippedCount = 0;
    
    // Process each product
    for (const product of products) {
      // Only add sizes to rings
      const isRing = product.category?.name?.toLowerCase().includes('ring');
      
      if (!isRing) {
        console.log(`‚è≠Ô∏è  Skipping: ${product.name} (not a ring)`);
        skippedCount++;
        continue;
      }
      
      // Skip if already has size variants
      if (product.sizeVariants && product.sizeVariants.length > 0) {
        console.log(`‚è≠Ô∏è  Skipping: ${product.name} (already has sizes)`);
        skippedCount++;
        continue;
      }
      
      // Generate size variants
      const sizeVariants = generateSizeVariants(product.price);
      
      // Update with SKU if product has one
      if (product.sku) {
        sizeVariants.forEach(variant => {
          variant.sku = `${product.sku}-SZ${variant.size.replace('.', '')}`;
        });
      }
      
      // Update the product
      await strapi.entityService.update('api::product.product', product.id, {
        data: {
          sizeVariants: sizeVariants,
        },
      });
      
      console.log(`‚úÖ Updated: ${product.name} (${sizeVariants.length} sizes added)`);
      updatedCount++;
    }
    
    console.log('\n' + '='.repeat(60));
    console.log(`\n‚ú® Size variants added successfully!`);
    console.log(`   üìä Updated: ${updatedCount} ring products`);
    console.log(`   ‚è≠Ô∏è  Skipped: ${skippedCount} products`);
    console.log(`   üì¶ Total: ${products.length} products\n`);
    
    // Gracefully shutdown Strapi
    await app.destroy();
    
    console.log('‚úÖ Done! Strapi shut down successfully.');
    process.exit(0);
    
  } catch (error) {
    console.error('\n‚ùå Error occurred:', error);
    console.error(error.stack);
    process.exit(1);
  }
}

// Run the script
main();

